---
title: "EDA: The Effect of Macroeconomic Indicators on Stock Market Performance"
author: "Liangqu Chen"
date: "7/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Exploratory data analysis for data set
The Effect of Macroeconomic Indicators on Stock Market Performance from 1967 to 2022

```{r}

# import library and clear the environment
library(corrplot)
library(outliers)
library(car)
library(WVPlots)
library(correlationfunnel)
library(ggthemes)
library(DataExplorer)
library(corrr)
library(ggplot2)
library(dplyr)
```


```{r}
# import data set
Macro_SP_MoM <- read.csv('Macro_SP_MoM.csv')
Macro_SP_QoQ <- read.csv('Macro_SP_QoQ.csv')

#rename the date
Macro_SP_MoM <- subset(Macro_SP_MoM,select=-c(date))
Macro_SP_QoQ <- subset(Macro_SP_QoQ,select=-c(date))
```

```{r}
summary(Macro_SP_MoM)
summary(Macro_SP_QoQ)
```

It is interesting to see that S&P500 max return was 12.0 % and min return is -20.3%, while the mean return is 0.66%

Let's look at SP500's histgram

```{r SP500, echo=FALSE}
hist(Macro_SP_MoM$SP500, xlab='S&P monthly returns', 
     main='S&P monthly return distribution from 1967 to 2021',
     breaks = 40, col='lightblue', ylim=c(0,100))
```
There are some outstanding points on the left of chart with about -20% returns.

```{r}
# shapiro wilk test to test its normalty
shapiro.test(Macro_SP_MoM$SP500)
```
Shapiro-Wilk test with the very low p-value rejects the null hypothesis that the data is normally distributed
But the normality test is prone to focus too much on the outliers.

```{r}
# QQ plot
qqnorm(Macro_SP_MoM$SP500)
```
qqplot is showing the a fat-tailed distribution of SP500. Expecially we can find two outstanding points on the bottom left corner.


```{r}

boxplot(Macro_SP_MoM$SP500, las=1, horizontal = TRUE, main='SP500 boxplot')

```



```{r}
grubbs.test(Macro_SP_MoM$SP500,type=10)
grubbs.test(Macro_SP_MoM$SP500,type=10, opposite=TRUE)
```

p-value for the lowest is extremely small thus we can reject the null hypothesis
and accept the alternative hypothesis that lowest value is an outlier

p-value for the highest value seems not significant enough thus not rejecting the null hypothesis

```{r}
# show the number of the lowest value
which.min(Macro_SP_MoM$SP500)
# remove the lowest values and test again
SP500_adj<- Macro_SP_MoM$SP500[-which.min(Macro_SP_MoM$SP500)]
# SP500_adj<- SP500_adj[-which.min(SP500_adj)]
grubbs.test(SP500_adj, type=10)
```
with the low p-value, we can accept the althernative hypothesis that the 2nd lowest value is an outlier

```{r}
# show the 2nd lowest value
which.min(SP500_adj)
# remove the lowest values and test again
SP500_adj<- SP500_adj[-which.min(SP500_adj)]
# SP500_adj<- SP500_adj[-which.min(SP500_adj)]
grubbs.test(SP500_adj, type=10)
```

we can also accept the alternative hypothesis that 3rd lowest value is an outlier with p-value<0.5

```{r}
# show the 3rd lowest value
which.min(SP500_adj)
# remove the lowest values and test again
SP500_adj<- SP500_adj[-which.min(SP500_adj)]
# SP500_adj<- SP500_adj[-which.min(SP500_adj)]
grubbs.test(SP500_adj, type=10)
```
we can also accept the alternative hypothesis that 4th lowest value is an outlier with p-value<0.05
```{r}
# show the 4th lowest value
which.min(SP500_adj)
# remove the lowest values and test again
SP500_adj<- SP500_adj[-which.min(SP500_adj)]
# SP500_adj<- SP500_adj[-which.min(SP500_adj)]
grubbs.test(SP500_adj, type=10)
```

now we can not really reject the null hypothesis

So potential outliers are points: 501, 637, 250, 249

do the shapiro wilk and draw QQ plot again
```{r}
# remove outliers
SP_outliers <- c(501, 637, 250,249)
SP500_adj < Macro_SP_MoM$SP500[-SP_outliers]

# QQ plot
qqnorm(SP500_adj)
```

Check collinearity between independent variables


```{r}
# plot the corrplot

corrplot(cor(Macro_SP_MoM[names(Macro_SP_MoM)!='SP500']), order='AOE')

```
It shows UNRATE has strong negative correlation with DFF, PCE, PAYEMS, INDPRO, GDPC1. There is another outstanding negative correlation relationship such as W068RCQ027SBEA with PAYEMS and INDPRO.  

Pairs of strong positive correlation as shown in the chart are UNRATE with W068RCQ027SBEA, CPIAUCSL with CPILFESL, PPIACO with CPIAUCSL, BOGZ1FA895050005Q with GDP and GDPC1. 

```{r,echo=FALSE}
# check VIF for each independent variables

model <- lm(SP500~., Macro_SP_MoM)
summary(model)

# plot vif and find vif value higher than 5
barplot(vif(model), main='VIF values', col='lightblue', las =2)
abline(h=5, lwd=3,lty=2)

```

Take a look at the linear relationship between predicators and response


Combined with the correlation plot, we can see the problematic pairs are: 
UNRATE*  with W068RCQ027SBEA (Government spending)
UNRATE*  with GDP* 
UNRATE*  with GDPC1 (real GDP)* 
UNRATE*  with INDPRO (Industrial output)
UNRATE*  with PAYEMS (Total Nonfarm Payrolls)* 
UNRATE*  with PCE (Personal Consumption Expenditures)
GDP*           with BOGZ1FA895050005Q (Capital Expenditure)* 
GDP*           with GDPC1 (real GDP)* 
GDPC1*    with BOGZ1FA895050005Q (Capital Expenditure)* 
PAYEMS*  with W068RCQ027SBEA (Government spending)
PAYEMS*  with GDPC1 (real GDP)* 
PAYEMS*  with INDPRO (Industrial output)
PAYEMS*  with PCE (Personal Consumption Expenditures)


*: VIF > 5

```{r}
# pairplot for the correlated variables
corr_variables = c('UNRATE', 'GDP', 'GDPC1','PAYEMS','W068RCQ027SBEA', 'INDPRO', 'BOGZ1FA895050005Q', 'PCE')
PairPlot(Macro_SP_MoM, corr_variables, 'Pair plot', point_color = 'red')

```

Solution for collinearity

Solution one
  keep GDPC1 (real GDP)
  Drop UNRATE (Unemployment rate)
  Drop GDP
  Drop PAYEMS (Non farm payroll)
  Drop BOGZ1FA895050005Q

Solution two
  Keep PAYEMS
  Drop GDP, GDPC1, UNRATE, 
  PAYEMS are predicting indexes, not delayed indexed like GDP, GDPC1, UNRATE

Solution three
  Keep UNRATE
  Drop PAYEMS, GDP, GDPC1, UNRATE
  Not considering combining two predictors because it is contradictory to the purpose of the project–quantified analysis on the       effect of single predictors

Solution one

```{r,echo=FALSE}
# check VIF for each independent variables
sol1_removed <- c('UNRATE', 'GDP', 'PAYEMS', 'BOGZ1FA895050005Q')
Macro_SP_MoM_sol1 <- Macro_SP_MoM[,-which(colnames(Macro_SP_MoM) %in% sol1_removed)]
Macro_SP_MoM_sol1.lm <- lm(SP500~., Macro_SP_MoM_sol1)
summary(Macro_SP_MoM_sol1.lm)

# plot vif and find vif value higher than 5
barplot(vif(Macro_SP_MoM_sol1.lm), main='VIF values', col='lightblue', las =2)
abline(h=5, lwd=3,lty=2)

```
```{r}
corrplot(cor(Macro_SP_MoM_sol1[names(Macro_SP_MoM_sol1)!='SP500']), order = 'AOE')

```


Solution two
  Keep PAYEMS
  Drop GDP, GDPC1, UNRATE, 
  PAYEMS are predicting indexes, not delayed indexed like GDP, GDPC1, UNRATE

```{r,echo=FALSE}
# check VIF for each independent variables
sol2_removed <- c('UNRATE', 'GDP', 'GDPC1')
Macro_SP_MoM_sol2 <- Macro_SP_MoM[,-which(colnames(Macro_SP_MoM) %in% sol2_removed)]
Macro_SP_MoM_sol2.lm <- lm(SP500~., Macro_SP_MoM_sol2)
summary(Macro_SP_MoM_sol2.lm)

# plot vif and find vif value higher than 5
barplot(vif(Macro_SP_MoM_sol2.lm), main='VIF values', col='lightblue', las =2)
abline(h=5, lwd=3,lty=2)

```
```{r}
corrplot(cor(Macro_SP_MoM_sol2[names(Macro_SP_MoM_sol2)!='SP500']), order='AOE')
```

Solution three
  Keep UNRATE
  Drop PAYEMS, GDP, GDPC1, UNRATE
  Not considering combining two predictors because it is contradictory to the purpose of the project–quantified analysis on the       effect of single predictors
  
```{r,echo=FALSE}
# check VIF for each independent variables
sol3_removed <- c('PAYEMS', 'GDP', 'GDPC1')
Macro_SP_MoM_sol3 <- Macro_SP_MoM[,-which(colnames(Macro_SP_MoM) %in% sol3_removed)]
Macro_SP_MoM_sol3.lm <- lm(SP500~., Macro_SP_MoM_sol3)
summary(Macro_SP_MoM_sol3.lm)

# plot vif and find vif value higher than 5
barplot(vif(Macro_SP_MoM_sol3.lm), main='VIF values', col='lightblue', las =2)
abline(h=5, lwd=3,lty=2)

```
```{r}
corrplot(cor(Macro_SP_MoM_sol3[names(Macro_SP_MoM_sol3)!='SP500']), order='AOE')
```



the relationship between SP500 and independent variables

```{r}

x<- Macro_SP_MoM %>% correlate() %>%focus(SP500)

x
```
```{r}
x %>%
  mutate(term = factor(term, levels = term[order(SP500)])) %>%  # Order by correlation strength
  ggplot(aes(x = term, y = SP500)) +
    geom_bar(stat = "identity") +
    ylab("Correlation with SP500 MoM") +
    xlab("Variable")+
  scale_x_discrete(guide = guide_axis(angle = 90))
```


```{r}
x<- subset(Macro_SP_QoQ, select=-shiller_PE) %>% correlate() %>%focus(SP500)

x

```

```{r}
x %>%
  mutate(term = factor(term, levels = term[order(SP500)])) %>%  # Order by correlation strength
  ggplot(aes(x = term, y = SP500)) +
    geom_bar(stat = "identity") +
    ylab("Correlation with SP500 QoQ") +
    xlab("Variable")+
  scale_x_discrete(guide = guide_axis(angle = 90))
```


