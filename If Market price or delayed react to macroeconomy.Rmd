---
title: "advance and delay SP500"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In the market, there are investors who usually price in their expection and they bet the directions of macroeconomic indexes beforehand. As a result, S&P 500 index shows the expectation. On the other hand, it sometime takes time for market to interpret and react to macroeconomic data. Thus we might see a delayed reaction of the market. To study whether the market intends to price in expections or has delayed reaction to macroeconomic data, we shift S&P 500 index by a range of [-12,12] months compared to the independent variables to examine the change of variance explained.


```{r}

# load the data
Macro_SP_MoM <- read.csv('Macro_SP_MoM.csv')

# remove date
Macro_SP_MoM <- subset(Macro_SP_MoM, select=-c(date))

# remove outliers
outliers <- c(249, 250, 501, 637)
MoM <- Macro_SP_MoM[-outliers,]

# remove shiller_PE and get predictor sets
MoM_pred <- subset(MoM,select=-c(SP500, shiller_PE))

# get response SP500 index set
MoM_res <- subset(MoM,select=c(SP500))

```

```{r}
# shift the SP500 D:delayed reaction, P:Price in expectation
D12 <- cbind(MoM_pred[1:646,],MoM_res[13:658,])
colnames(D12)[ncol(D12)] <- 'SP500'

D11 <- cbind(MoM_pred[1:647,],MoM_res[12:658,])
colnames(D11)[ncol(D11)] <- 'SP500'

D10 <- cbind(MoM_pred[1:648,],MoM_res[11:658,])
colnames(D10)[ncol(D10)] <- 'SP500'

D09 <- cbind(MoM_pred[1:649,],MoM_res[10:658,])
colnames(D09)[ncol(D09)] <- 'SP500'

D08 <- cbind(MoM_pred[1:650,],MoM_res[9:658,])
colnames(D08)[ncol(D08)] <- 'SP500'

D07 <- cbind(MoM_pred[1:651,],MoM_res[8:658,])
colnames(D07)[ncol(D07)] <- 'SP500'

D06 <- cbind(MoM_pred[1:652,],MoM_res[7:658,])
colnames(D06)[ncol(D06)] <- 'SP500'

D05 <- cbind(MoM_pred[1:653,],MoM_res[6:658,])
colnames(D05)[ncol(D05)] <- 'SP500'

D04 <- cbind(MoM_pred[1:654,],MoM_res[5:658,])
colnames(D04)[ncol(D04)] <- 'SP500'

D03 <- cbind(MoM_pred[1:655,],MoM_res[4:658,])
colnames(D03)[ncol(D03)] <- 'SP500'

D02 <- cbind(MoM_pred[1:656,],MoM_res[3:658,])
colnames(D02)[ncol(D02)] <- 'SP500'

D01 <- cbind(MoM_pred[1:657,],MoM_res[2:658,])
colnames(D01)[ncol(D01)] <- 'SP500'

D00 <- cbind(MoM_pred[1:658,],MoM_res[1:658,])
colnames(D00)[ncol(D00)] <- 'SP500'

P01 <- cbind(MoM_pred[2:658,],MoM_res[1:657,])
colnames(P01)[ncol(P01)] <- 'SP500'

P02 <- cbind(MoM_pred[3:658,],MoM_res[1:656,])
colnames(P02)[ncol(P02)] <- 'SP500'

P03 <- cbind(MoM_pred[4:658,],MoM_res[1:655,])
colnames(P03)[ncol(P03)] <- 'SP500'

P04 <- cbind(MoM_pred[5:658,],MoM_res[1:654,])
colnames(P04)[ncol(P04)] <- 'SP500'

P05 <- cbind(MoM_pred[6:658,],MoM_res[1:653,])
colnames(P05)[ncol(P05)] <- 'SP500'

P06 <- cbind(MoM_pred[7:658,],MoM_res[1:652,])
colnames(P06)[ncol(P06)] <- 'SP500'

P07 <- cbind(MoM_pred[8:658,],MoM_res[1:651,])
colnames(P07)[ncol(P07)] <- 'SP500'

P08 <- cbind(MoM_pred[9:658,],MoM_res[1:650,])
colnames(P08)[ncol(P08)] <- 'SP500'

P09 <- cbind(MoM_pred[10:658,],MoM_res[1:649,])
colnames(P09)[ncol(P09)] <- 'SP500'

P10 <- cbind(MoM_pred[11:658,],MoM_res[1:648,])
colnames(P10)[ncol(P10)] <- 'SP500'

P11 <- cbind(MoM_pred[12:658,],MoM_res[1:647,])
colnames(P11)[ncol(P11)] <- 'SP500'

P12 <- cbind(MoM_pred[13:658,],MoM_res[1:646,])
colnames(P12)[ncol(P12)] <- 'SP500'
```


Now we can train a linear model with all the dataset and record the R2

```{r}

R2_all <-c()

datasets <- list(P12,P11,P10,P09,P08,P07,P06,P05,P04,P03,P02,P01,D00,D01,D02,D03,D04,D05,D06,D07,D08,D09,D10,D11,D12)

for (d in datasets) {
  R2_all <- cbind(R2_all, summary(lm(SP500~., d))$adj.r.squared)
}

R2_all <-as.data.frame(R2_all)
names(R2_all) <-c('P12','P11','P10','P09','P08','P07','P06','P05','P04','P03','P02','P01','D00','D01'
                             ,'D02','D03','D04','D05','D06','D07','D08','D09','D10','D11','D12')
R2_all
```


```{r}

R2_5 <-c()

datasets <- list(P12,P11,P10,P09,P08,P07,P06,P05,P04,P03,P02,P01,D00,D01,D02,D03,D04,D05,D06,D07,D08,D09,D10,D11,D12)

for (d in datasets) {
  R2_5 <- cbind(R2_5, summary(lm(SP500~UNRATE+UMCSENT+PCE+ICSA+DXY, d))$adj.r.squared)
}

R2_5 <-as.data.frame(R2_5)
names(R2_5) <-c('P12','P11','P10','P09','P08','P07','P06','P05','P04','P03','P02','P01','D00','D01'
                             ,'D02','D03','D04','D05','D06','D07','D08','D09','D10','D11','D12')
R2_5
```


Visualizations

```{r}
library(ggplot2)

# transpose
R2_all <- t(R2_all)
#R2_all <- cbind(PD = rownames(R2_all), R2_all)
#rownames(R2_all) <- 1:nrow(R2_all)

R2_5 <- t(R2_5)
#R2_5 <- cbind(PD = rownames(R2_5), R2_5)
#rownames(R2_5) <- 1:nrow(R2_5)

df <- as.data.frame(cbind(R2_all,R2_5))
df <- cbind(PD = rownames(df), df)
rownames(df) <- 1:nrow(df)
df$ind <- seq(-12,12)

names(df) <- c('PD', 'All_Predictors','Predictors_5','ind')

# melt
library(reshape2)
df <- melt(df, id.vars=c('PD','ind'))


ggplot(df, aes(x=ind,y=value,color=variable))+
         geom_line()+
         xlab('Price in (-) or Delayed Reaction (+) in Months')+
         ylab('R2')+
         scale_x_continuous(labels = as.character(df$ind), breaks = df$ind)

```


It seems the “no shift” model still has the best R2. But it might be true the market is likely to price in a month earlier as (-1)’s R2 is not much lower than “no shift”.